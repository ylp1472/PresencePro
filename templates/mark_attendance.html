{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block extra_css %}
<style>
    #video-container {
        position: relative;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }
    #video {
        width: 100%;
        height: auto;
    }
    #canvas {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Mark Attendance</h1>

<div id="video-container">
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
</div>

<div class="mt-4 text-center">
    <button id="capture-btn" class="btn btn-primary">Capture and Mark Attendance</button>
</div>

<div id="recognition-results" class="mt-4"></div>
{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const recognitionResults = document.getElementById('recognition-results');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("Error accessing the camera", err);
        });

    captureBtn.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'capture.jpg');

            fetch('{{ url_for("process_attendance") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                recognitionResults.innerHTML = `<h3>Recognized Students:</h3><ul>`;
                data.forEach(student => {
                    recognitionResults.innerHTML += `<li>${student}</li>`;
                });
                recognitionResults.innerHTML += `</ul>`;
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }, 'image/jpeg');
    });
</script>
{% endblock %}